---

title: Try news commentary data with gru2gru model

keywords: fastai
sidebar: home_sidebar


---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/95_nc_gru2gru.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.basics</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="k">import</span> <span class="n">AutoTokenizer</span>
<span class="kn">from</span> <span class="nn">fastai_transformers_utils.all</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">nmt_try.models.patch</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nmt_try.models.gru2gru</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nmt_try.data.news_commentary</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nmt_try.metrics</span> <span class="k">import</span> <span class="n">compute_bleu</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<p style="color: red;">
The default version of TensorFlow in Colab will soon switch to TensorFlow 2.x.<br>
We recommend you <a href="https://www.tensorflow.org/guide/migrate" target="_blank">upgrade</a> now 
or ensure your notebook will continue to use TensorFlow 1.x via the <code>%tensorflow_version 1.x</code> magic:
<a href="https://colab.research.google.com/notebooks/tensorflow_version.ipynb" target="_blank">more info</a>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># all_skip</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok_data_loc</span> <span class="o">=</span> <span class="s1">&#39;./data/News_Commentary/tok-news-commentary-v14.en-zh.csv&#39;</span>
<span class="n">enc_model_name</span> <span class="o">=</span> <span class="s1">&#39;bert-base-cased&#39;</span>
<span class="n">dec_model_name</span> <span class="o">=</span> <span class="s1">&#39;hfl/chinese-bert-wwm-ext&#39;</span>
<span class="n">enc_seq_len</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">dec_seq_len</span> <span class="o">=</span> <span class="mi">65</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">enc_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">enc_model_name</span><span class="p">)</span>
<span class="n">dec_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">dec_model_name</span><span class="p">)</span>
<span class="n">dec_tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">({</span><span class="s1">&#39;bos_token&#39;</span><span class="p">:</span> <span class="s1">&#39;[CLS]&#39;</span><span class="p">,</span> <span class="s1">&#39;eos_token&#39;</span><span class="p">:</span> <span class="s1">&#39;[SEP]&#39;</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Datasets">Datasets<a class="anchor-link" href="#Datasets">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">small_dss</span> <span class="o">=</span> <span class="n">get_nc_dss</span><span class="p">(</span><span class="n">tok_data_loc</span><span class="p">,</span> <span class="n">enc_tokenizer</span><span class="p">,</span> <span class="n">dec_tokenizer</span><span class="p">,</span> <span class="n">enc_seq_len</span><span class="p">,</span> <span class="n">dec_seq_len</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">dss</span> <span class="o">=</span> <span class="n">get_nc_dss</span><span class="p">(</span><span class="n">tok_data_loc</span><span class="p">,</span> <span class="n">enc_tokenizer</span><span class="p">,</span> <span class="n">dec_tokenizer</span><span class="p">,</span> <span class="n">enc_seq_len</span><span class="p">,</span> <span class="n">dec_seq_len</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model">Model<a class="anchor-link" href="#Model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">enc_vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_tokenizer</span><span class="p">)</span>
<span class="n">enc_pad_id</span> <span class="o">=</span> <span class="n">enc_tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>

<span class="n">dec_vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dec_tokenizer</span><span class="p">)</span>
<span class="n">dec_pad_id</span> <span class="o">=</span> <span class="n">dec_tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>

<span class="n">embeded_size</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">num_encoder_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_decoder_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">drop_p</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">xdel</span> gru2gru
<span class="o">%</span><span class="k">xdel</span> decoder
<span class="o">%</span><span class="k">xdel</span> encoder
<span class="n">encoder</span> <span class="o">=</span> <span class="n">GRUEncoder</span><span class="p">(</span><span class="n">enc_vocab_size</span><span class="p">,</span> <span class="n">embeded_size</span><span class="p">,</span> <span class="n">enc_pad_id</span><span class="p">,</span> <span class="n">num_encoder_layers</span><span class="p">,</span> <span class="n">drop_p</span><span class="p">)</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">GRUDecoder</span><span class="p">(</span><span class="n">dec_vocab_size</span><span class="p">,</span> <span class="n">embeded_size</span><span class="p">,</span> <span class="n">dec_pad_id</span><span class="p">,</span> <span class="n">num_decoder_layers</span><span class="p">,</span> <span class="n">drop_p</span><span class="p">)</span>
<span class="n">gru2gru</span> <span class="o">=</span> <span class="n">GRU2GRU</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">num_encoder_layers</span><span class="p">,</span> <span class="n">num_decoder_layers</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>NameError: name &#39;gru2gru&#39; is not defined
NameError: name &#39;decoder&#39; is not defined
NameError: name &#39;encoder&#39; is not defined
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Learner-and-Train">Learner and Train<a class="anchor-link" href="#Learner-and-Train">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">xdel</span> dls
<span class="o">%</span><span class="k">xdel</span> learn
<span class="c1"># dls = small_dss.dataloaders(bs=64)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> 
                <span class="n">gru2gru</span><span class="p">,</span> 
                <span class="n">loss_func</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="n">dec_pad_id</span><span class="p">),</span> 
                <span class="n">opt_func</span><span class="o">=</span><span class="n">Adam</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">Perplexity</span><span class="p">()],</span>
               <span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>NameError: name &#39;dls&#39; is not defined
NameError: name &#39;learn&#39; is not defined
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(0.0019054606556892395, 0.0014454397605732083)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAX4AAAEKCAYAAAAVaT4rAAAABHNCSVQICAgIfAhkiAAAAAlwSFlz
AAALEgAACxIB0t1+/AAAADh0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4xLjMsIGh0
dHA6Ly9tYXRwbG90bGliLm9yZy+AADFEAAAeAElEQVR4nO3de5hcdZ3n8fe3qruTdHc6JH3JDUIu
hEC4CCTc5BZWRMZ1RNBVcVxlYGDxul4Wx1mf1Z15xsuKroMyjsMgwqqgCDoC6igiGO4QQCBpLgmQ
YNJNujsJXd3p9K3qu39UVVI03Ulf6tQ5p+rzep56uur0qfP75qT7U6fP+Z3fz9wdERGpHImwCxAR
kdJS8IuIVBgFv4hIhVHwi4hUGAW/iEiFUfCLiFSYqrALGI+mpiZfvHhx2GWIiMTK448/3uXuzSOX
xyL4Fy9ezLp168IuQ0QkVsxsy2jLdapHRKTCKPhFRCqMgl9EpMIo+EVEKoyCX0Skwij4RUQqjIJf
RCSCuvcM8R/rX6Wrd6Do21bwi4hE0MbtPVzxo8fZ0JYq+rYV/CIiEdTZkz3Sb66fVvRtK/hFRCKo
M3eKp6VBwS8iUhE6UgMkE8bs2pqib1vBLyISQZ09AzTW1ZBMWNG3reAXEYmgzt4BmmcW/zQPKPhF
RCKps2eAFgW/iEjl6Ojp1xG/iEilyGScrt5BBb+ISKXY1TdIOuOB9OEHBb+ISOTk+/A3z5weyPYV
/CIiEZO/azeIm7dAwS8iEjkdqeCGawAFv4hI5Ow71aPgFxGpCJ09A9TWJKmbVhXI9hX8IiIRE+TN
W6DgFxGJnCBv3gIFv4hI5HT2BDdODyj4RUQip7NnILAePaDgFxGJlP6hNKn+YVoagrl5CxT8IiKR
EuSUi3kKfhGRCAm6Dz8o+EVEImXvEb+CX0SkMuwdp0fBLyJSGTp6BjCDOXXFn2Q9L7DgN7PrzazD
zNaPWP4JM3vOzDaY2deDal9EJI7yk6xXJYM7Lg/yiP8G4LzCBWZ2NnA+8CZ3Pwr4RoDti4jETmfP
AE0B9uiBAIPf3dcCO0cs/gjwNXcfyK3TEVT7IiJx1Nk7EGgffij9Of7DgTPM7BEz+6OZnTjWimZ2
uZmtM7N1nZ2dJSxRRCQ8nan+QPvwQ+mDvwqYA5wCXAncYmY22orufq27r3b31c3NzaWsUUQkFO5O
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
d2/PPX8VmDvWimZ2OXA5wKJFiybV2Bd/uZ4fPbyFZMJImO39agAGlm0n197rX++to+C557+6M5qp
XNkfa5tjOVBbE6nkjZuyA3z/jWvm17EDtJzfz9nno6+7d1u2b3uF/z8j//+sYN19780uTySyyxO5
lRIGidzX/PoJMxKJ/PKCdRJGcsT3koncw4xk0qhKGFWJBFX558kENcns1+rc8+pkgpqq7OtpVQmm
VyeZXp1kRnWS2mlJ6mqqqMt9TSTi1TukUt2/qYuaZIKTFs8Ju5RJKXXw7+XubmZjpp27XwtcC7B6
9eqJpWLOmcubaZheTdqdTMZJZ5yMg+MU5qy748DI7HXe2GxhEL2+3je+d38hONr3x/u5caDPiNHq
Hu+2Rr5z/23569YZT1171x2jnb21++s/aPP/P17wmoL/Sy98vnd7uf/v3Pr55xnPrpf/OpzJ4Gn2
/pw42a562Z+X7DYy+Z8hdzKZ7HvSGWc446TTzlAmw3A6+3qyzGDWjGrm1NZwUG01zTOnsWhOLYsa
61g0p5Yj5s1kbsP0SW9fiuf+jV2sOnQ2M2qSYZcyKaUO/u1mNt/d281sPtARZGPnrJzLOSvH/KNC
pOjcs+E/lM4wNJz9QBgczj3SGQaGMvQPp+kfStM/lKFvcJjegWH6BtL09A+xq2+IXX2D7Oob5MXO
3dz7fCcDw5m92z9kzgxOWtzISUtmc/aKFlr0QVByXb0DtLanuPJtK8IuZdJKHfy3Ax8Gvpb7+ssS
ty8SKDOjOnd6h5qpby+TcTp7B9jctZtntnXz2Oad3PN8B7c9sZWEZbsSXnjCQt521Dxqa0L7A76i
PPjiDiCe3TjzAvtJMbObgTVAk5ltBb5ENvBvMbNLgS3Ae4NqX6QcJBLG3IbpzG2YzslLG/mbM5bi
7rywvZc7n27jF09u49M/fYramvW8d/UhXHr6Eg6ZUxt22WXtgY1dNEyv4piF8RqYrVBgwe/uF43x
rbcE1aZIJTAzVsybyYp5K/j0OYezbssufvLYK/z4kS388OEt/Odj5nP5mUs5OsbBFFX9Q2nufm47
px3WRDLGF+L1t6FIjCUSxklL5nDSkjlc+bYV/OCBzdz0yCvc/lQbb17WyN+csYQ1h7eot1CR/Gzd
n+nqHeRDpy4Ou5QpsYl2IwzD6tWrfd26dWGXIRIL3XuGuOmRV7jxwc28mupnWXMdl52xlHevOjh7
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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>3.203824</td>
      <td>3.164581</td>
      <td>0.234390</td>
      <td>23.678822</td>
      <td>12:48</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2.827919</td>
      <td>2.825433</td>
      <td>0.257798</td>
      <td>16.868248</td>
      <td>12:43</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2.521305</td>
      <td>2.685969</td>
      <td>0.269450</td>
      <td>14.672414</td>
      <td>12:38</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gru2gru</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;./models/1-nc_gru2gru.pt&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">gru2gru</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./models/1-nc_gru2gru.pt&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;All keys matched successfully&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Bleu">Bleu<a class="anchor-link" href="#Bleu">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">generated_gru2gru</span> <span class="o">=</span> <span class="n">GeneratedGRU2GRU</span><span class="p">(</span><span class="n">gru2gru</span><span class="p">,</span> <span class="n">enc_tokenizer</span><span class="p">,</span> <span class="n">dec_tokenizer</span><span class="p">)</span>
<span class="n">generate_args</span> <span class="o">=</span> <span class="n">GenerateArgs</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="c1">#     do_sample=True,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="c1">#     temperature=1.0,</span>
<span class="c1">#     repetition_penalty=1,</span>
<span class="c1">#     length_penalty=1.0,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_bleu</span><span class="p">(</span><span class="n">generated_gru2gru</span><span class="p">,</span> <span class="n">generate_args</span><span class="p">,</span> <span class="n">dec_tokenizer</span><span class="p">,</span> <span class="n">dls</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='764' class='' max='801', style='width:300px; height:20px; vertical-align: middle;'></progress>
      95.38% [764/801 08:37<00:25]
    </div>
    
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Generate">Generate<a class="anchor-link" href="#Generate">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">generate_args</span> <span class="o">=</span> <span class="n">GenerateArgs</span><span class="p">(</span>   
    <span class="n">max_length</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span>
<span class="c1">#     do_sample=True,</span>
    <span class="n">num_beams</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="c1">#     top_k=3, </span>
<span class="c1">#     top_p=0.9, </span>
<span class="c1">#     repetition_penalty=5,</span>
<span class="c1">#     length_penalty=6,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">src_strs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;They have their own vision; their own planners, architects, and engineers; and their own manpower.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;As demand rises, more and better jobs will be created not only in Asia, but also globally, along supply chains and across production networks.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;If the EU is to progress beyond the limits of a common economic and monetary policy and develop a defense and security policy along with a common foreign policy, the UK must be on board.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Today, when a new strain of influenza appears in Asia, scientists collect a throat swab, isolate the virus, and run the strain’s genetic sequence.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Other elements of Lee’s plan include construction of eco-friendly transportation networks, such as high-speed railways and hundreds of kilometers of bicycle tracks, and generating energy using waste methane from landfills.&#39;</span><span class="p">,</span>

<span class="p">]</span>
<span class="n">tgt_strs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;他们有自己的愿景，自己的规划师、建筑师和工程师，自己的劳动力。&#39;</span><span class="p">,</span>
    <span class="s1">&#39;随着需求不断攀升，不仅亚洲会创造出更多更好的就业机会，全球范围内的供应链及整个生产网络也将会从中受益。&#39;</span><span class="p">,</span>
    <span class="s1">&#39;如果欧盟想要突破共同的经济和货币政策的界限，在发展安全防卫政策的同时发展共同的外交政策，英国必须参与。&#39;</span><span class="p">,</span>
    <span class="s1">&#39;如今，当新的流感菌株在亚洲出现时，科学家收集咽喉棉签，分离病毒，测定毒株的基因序列。&#39;</span><span class="p">,</span>
    <span class="s1">&#39;李总统计划的其他要素还包括建设生态友好的运输网络，例如高速铁路以及几百公里长的自行车车道，并且从垃圾堆中利用甲烷来制造能源。&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">generated_gru2gru</span><span class="o">.</span><span class="n">generate_from_strs</span><span class="p">(</span><span class="n">src_strs</span><span class="p">,</span> <span class="n">generate_args</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;他 们 自 己 的 政 治 权 利 ， 但 他 们 自 己 的 计 划 往 往 会 在 他 们 自 己 的 国 家 和 地 方 层 面 上 做 出 了 不 同 的 结 果 。&#39;,
 &#39;随 着 全 球 供 应 链 的 供 应 链 ， 需 求 不 足 ， 而 不 仅 仅 是 供 应 链 ， 还 能 提 供 更 多 的 供 给 链 。&#39;,
 &#39;如 果 欧 盟 成 员 国 经 济 政 策 和 外 交 政 策 的 必 要 条 件 ， 那 么 货 币 联 盟 就 是 明 证 。&#39;,
 &#39;如 今 ， 亚 洲 的 科 学 家 们 看 到 了 一 个 新 药 物 ， 并 且 随 着 时 间 的 推 移 ， 我 们 似 乎 正 在 开 始 寻 找 替 罪 羊 。&#39;,
 &#39;李 嘉 图 的 计 划 规 模 包 括 汽 车 和 汽 车 制 造 商 的 汽 车 制 造 商 ， 包 括 汽 车 和 汽 车 制 造 商 的 汽 车 制 造 商 。&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}
</div>
 

